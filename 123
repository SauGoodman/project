import json
import logging
import awswrangler as wr
import pandas as pd
import requests

# ログ初期化
logger = logging.getLogger()
logger.setLevel(logging.INFO)

def lambda_handler(event, context):
    try:
        # S3バケットとファイルパスを定義
        bucket_name = "mastergpoc"  # S3バケット名
        input_file_key = "temp/01_product_compare.csv"  # 入力CSVファイルのパス
        post_file_key = "results/01_product_apipost.csv"  # POST結果を保存するパス
        put_file_key = "results/01_product_apiput.csv"  # PUT結果を保存するパス

        logger.info(f"S3からファイルを読み込み中: s3://{bucket_name}/{input_file_key}")

        # S3からCSVファイルを読み込む
        try:
            data = wr.s3.read_csv(f's3://{bucket_name}/{input_file_key}')
        except Exception as e:
            logger.error(f"S3ファイルの読み込みに失敗しました: {str(e)}")
            return {"statusCode": 500, "body": f"S3ファイルの読み込みに失敗しました: {str(e)}"}

        # APIリクエスト用のURLを作成
        buturyu_cd_list = data['buturyu_cd'].tolist()  # CSVから配送コードを取得
        joined_buturyu_cd = "&".join(map(str, buturyu_cd_list))  # 配送コードを結合
        api_url = f"https://api.plapi-product.com/plapi/api/v1/com_product_id/catalogs?{joined_buturyu_cd}"  # API URL作成
        logger.info(f"生成されたAPI URL: {api_url}")

        # トークンとヘッダーを設定
        token = "Bearer <YOUR_ACCESS_TOKEN>"  # APIトークン（適切なトークンに置き換え）
        headers = {
            "User-Agent": "test-agent",  # ユーザーエージェント
            "Authorization": token,  # 認証トークン
            "ClientId": "75"  # クライアントID
        }

        # APIリクエストを送信
        logger.info("APIリクエストを送信中...")
        response = requests.get(api_url, headers=headers)
        if response.status_code not in [200, 400]:
            logger.error(f"APIリクエストが失敗しました: {response.status_code} - {response.text}")
            return {"statusCode": response.status_code, "body": f"APIリクエストが失敗しました: {response.text}"}

        # APIレスポンスを解析
        try:
            api_data = response.json()
        except json.JSONDecodeError:
            logger.error(f"APIレスポンスのデコードに失敗しました: {response.text}")
            return {"statusCode": 500, "body": "APIレスポンスのデコードに失敗しました。"}

        logger.info(f"APIレスポンスを受信しました: {api_data}")

        # APIレスポンスの処理
        errors = api_data.get("errors", [])  # エラー情報を取得
        templates = api_data.get("templates", [])  # テンプレート情報を取得

        # エラーとテンプレートのIDを取得
        error_ids = {str(error["com_product_id"]) for error in errors}
        template_dict = {str(template["com_product_id"]): template["product_id"] for template in templates}

        # データをPOST用とPUT用に分ける
        post_df = data[data["buturyu_cd"].isin(error_ids)]  # POST用のデータフレーム
        put_df = data[data["buturyu_cd"].isin(template_dict.keys())]  # PUT用のデータフレーム

        # PUTデータフレームのproduct_idを更新
        put_df["product_id"] = put_df["buturyu_cd"].map(template_dict)  # product_idをマッピング
        put_df = put_df[["product_id"] + list(data.columns)]  # カラム順を調整

        # 処理結果をS3に保存
        if not post_df.empty:
            wr.s3.to_csv(post_df, f's3://{bucket_name}/{post_file_key}', index=False)  # POST結果を保存
            logger.info(f"POST結果を保存しました: s3://{bucket_name}/{post_file_key}")

        if not put_df.empty:
            wr.s3.to_csv(put_df, f's3://{bucket_name}/{put_file_key}', index=False)  # PUT結果を保存
            logger.info(f"PUT結果を保存しました: s3://{bucket_name}/{put_file_key}")

        logger.info("プロセスが正常に完了しました。")
        return {"statusCode": 200, "body": json.dumps("プロセスが正常に完了しました。")}

    except Exception as e:
        logger.error(f"エラーが発生しました: {str(e)}")
        return {"statusCode": 500, "body": f"エラー: {str(e)}"}